var app=app||{};app.CmapView=Backbone.View.extend({el:"#treatment-cmap",events:{"click #instruction-read":"renderEditor","click #help":"renderInstructionModal","click #editor-button":"analyzeText","click #editor-full-button":"saveText"},initialize:function(){var e=this;this.prePageDurationStart=null,this.postPageDurationStart=null,this.colors=d3.scaleOrdinal(d3.schemeCategory10),this.simulations={},this.userModel=new app.UserSpecificModel,this.textModel=new app.TextModelComplete,this.analyzer=new app.TextAnalyzerModel,this.userModel.fetch({success:function(t,n){e.renderInstruction()},error:function(e,t){console.log(t)}})},renderInstruction:function(){this.$el.html(Handlebars.templates.instruction({instruction:this.userModel.get("instruction")}))},renderEditor:function(){this.prePageDurationStart=new Date,this.$el.html(Handlebars.templates.editor());var e=new MediumEditor("#editor-textinput",{toolbar:!1,placeholder:!1});$("#editor-textinput").html("<p>Schreibe hier ...</p>");var t=document.querySelector("#editor-textinput").firstChild;e.selectElement(t),this.$el.append('<i id="help" class="material-icons">help</i>'),this.$el.append(Handlebars.templates["modal-help"]({instruction:this.userModel.get("instruction")}))},renderInstructionModal:function(){$("#modal-help").openModal()},analyzeText:function(){var e=this;app.regExText("#editor-textinput");var t=app.getParagraphs(this.$el.find("#editor-textinput")),n=app.getPlainText(this.$el.find("#editor-textinput"));if(t.length<300)Materialize.toast("Ihr Text ist leider zu kurz.",4e3);else{var r=(new Date-this.prePageDurationStart)/1e3;this.postPageDurationStart=new Date,this.textModel.set({pre_page_duration:r,pre_text:n}),this.$el.find("#editor-button-div").html(Handlebars.templates["loading-ring"]()),this.analyzer.set({text:t}),this.analyzer.save(null,{success:function(t){e.renderRevision()},error:function(e,t){console.log(t.responseText)}})}},renderRevision:function(){this.$el.find("#editor-button-div").html('<a class="waves-effect waves-light btn" id="save-text">Text abschicken</a>'),this.textModel.set({pre_num_sentences:this.analyzer.get("numSentences"),pre_num_clusters:this.analyzer.get("numCluster"),pre_num_coherent_sentences:this.analyzer.get("cohSentences"),pre_num_non_coherent_sentences:this.analyzer.get("cohNotSentences"),pre_num_concepts:this.analyzer.get("numConcepts"),pre_local_cohesion:this.analyzer.get("local cohesion")}),this.paragraphs=$("#editor-textinput").html(),this.$el.html(Handlebars.templates["editor-full"]({instruction:app.constants.simpleRevisionModal})),this.$el.append('<i id="help" class="material-icons">help</i>'),this.$el.append(Handlebars.templates["modal-help"]({instruction:this.userModel.get("instructionreview")})),$("#editor-full-medium-editor").html(this.paragraphs);new MediumEditor("#editor-full-medium-editor",{toolbar:!1});$("#editor-full-button").text("Text abschicken"),this.$el.append(Handlebars.templates["modal-revision"]({instruction:this.userModel.get("instructionreview")})),$("#modal-revision").openModal();var e=$("#editor-full-graph").width(),t=$("#editor-full-medium-editor").height();this.renderCmap(this.analyzer.get("word_pairs"),this.analyzer.get("numConcepts"),this.analyzer.get("numClusters"),"#editor-full-graph",t,e,this.colors)},printText:function(){},renderCmap:function(t,n,r,i,a,s,o){function l(){m.attr("transform",d3.event.transform),g.attr("transform",d3.event.transform)}function c(){f.selectAll("text").style("font-weight","normal").style("font-size","16px"),f.selectAll("circle").style("stroke","none").style("stroke-width",0);var e=d3.mouse(this),t=y.find(e[0],e[1]),n=m.select("#node-"+t.id);n.data()[0];n.select("text").style("opacity",1).style("font-weight","bold").style("font-size","20px"),n.select("circle").style("stroke","#000").style("stroke-width",1);t.id}function d(){f.selectAll("text").style("font-weight","normal").style("font-size","16px"),f.selectAll("circle").style("stroke","none").style("stroke-width",0),$("#editor-full-medium-editor").find("p").each(function(e){var t=$(this).text(),n=t.replace(/([A-z0-9'<>\u00dc\u00fc\u00e4\u00c4\u00f6\u00d6\u00df\-\/]+)/g,"<span>$1</span>"),r=$(n);$(this).html(r),$(this).append(".")})}var u=this,p=(window.innerHeight||e.clientHeight||m.clientHeight)-50,h=s,f=d3.select(i).append("svg").attr("width",h-5).attr("height",p),m=f.append("g").attr("width",h).attr("height",p),g=f.append("rect").attr("class","overlay").attr("width",h).attr("height",p).style("fill","red").style("opacity",0).on("mousemove",c).on("mouseleave",d);f.call(d3.zoom().scaleExtent([.5,1.5]).on("zoom",l));var y=(f.append("line").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",0).style("stroke","red").style("stroke-width","2"),d3.scaleLinear().domain([0,1]).range([0,h]),d3.forceSimulation(u.analyzer.get("nodes")).force("charge",d3.forceManyBody().strength(-250)).force("link",d3.forceLink(u.analyzer.get("links")).distance(80).id(function(e){return e.id})).force("center",d3.forceCenter(h/2,p/2)).force("collision",d3.forceCollide().radius(50)).force("x",d3.forceX()).force("y",d3.forceY()).stop());d3.timeout(function(){for(var e=0,t=Math.ceil(Math.log(y.alphaMin())/Math.log(1-y.alphaDecay()));e<t;++e)y.tick();var n=(m.append("g").attr("class","links").selectAll("line").data(u.analyzer.get("links")).enter().append("line").attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}).style("stroke-dasharray",function(e){if("coreference"==e.device)return"5,5"}).style("d",function(e){if("coreference"==e.device)return"M5 20 l215 0"}),m.append("g").attr("class","nodes").selectAll(".node").data(u.analyzer.get("nodes")).enter().append("g").attr("id",function(e,t){return"node-"+e.id}).attr("class","node").attr("transform",function(e){return"translate("+e.x+","+e.y+")"}));n.append("circle").attr("r",10).attr("cx",0).attr("cy",0).style("fill",function(e,t){return u.colors(u.analyzer.get("word_cluster_index")[e.id])}).attr("fill","#ccc"),n.append("text").attr("dy",-8).attr("dx",10).style("opacity",.8).attr("text-anchor","start").text(function(e){return e.id})})},saveText:function(){var e=this,t=(new Date-this.postPageDurationStart)/1e3;this.$el.find("#editor-full-button-div").html(Handlebars.templates["loading-ring"]());var n=app.getParagraphs(this.$el.find("#editor-full-medium-editor")),r=app.getPlainText(this.$el.find("#editor-full-medium-editor"));this.textModel.set({post_text:r,post_page_duration:t}),this.analyzer.set({text:n}),this.analyzer.save(null,{success:function(t){e.sendToServer()},error:function(e,t){console.log(t.responseText)}})},sendToServer:function(){this.textModel.set({post_num_sentences:this.analyzer.get("numSentences"),post_num_clusters:this.analyzer.get("numCluster"),post_num_coherent_sentences:this.analyzer.get("cohSentences"),post_num_non_coherent_sentences:this.analyzer.get("cohNotSentences"),post_num_concepts:this.analyzer.get("numConcepts"),post_local_cohesion:this.analyzer.get("local cohesion")}),this.textModel.save(null,{success:function(e){location.reload()},error:function(e,t){console.log("error")}})}}),new app.CmapView;
//# sourceMappingURL=cmap.js.map
